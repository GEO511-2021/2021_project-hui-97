---
title: "My Final Project First draft"
author: Hui Gao
subtitle: Subtitle here if desired
output:
  html_document:
    code_folding: show
---

# Introduction

Jakobshavn Isbrae, one of the largest tidewater glaciers in Greenland, has been exhibiting complex spatiotemporal behaviors. After ~20 years of acceleration, retreating, and thinning, it started to decelerate, readvance, and thicken beginning in 2016. The acceleration and retreat resumed in 2019. Understanding the driving mechanisms of these changes, especially the reversal in 2016, is essential to predict its future contribution to sea-level rise under different scenarios of climate change.

Previous studies found that decreased submarine melt and extended existence of rigid melange as a result of ocean cooling near the terminus are strong candidates for causing the reversal. However, the roles of the subglacial drainage system and the atmospheric temperature remain elusive. This project aims to compare the relationships of ice surface velocity with the subglacial drainage system and air temperature to quantify their impact on the short reversal of Jakobshavn Isbrae in 2016. 

# Materials and methods

[~ 200 words]

Narrative: Clear narrative description of the data sources and methods. Includes data from at least two sources that were integrated / merged in R.

Code: The code associated with the project is well organized and easy to follow. Demonstrates mastery of R graphics and functions.

Data: The underlying data are publicly accessible via the web and downloaded/accessed within the Rmd script. If you want to use your own data, you must make it available on a website (e.g. Figshare) so that others are able to re-run your code.

You can do bullets like this:

* The first most important thing
* The second most important thing
* The third most important thing

You can do numbers like this:

1. The first most important thing
2. The second most important thing
3. The third most important thing

See [http://rmarkdown.rstudio.com/](http://rmarkdown.rstudio.com/) for all the amazing things you can do.

## Load packages
```{r, message=F, warning=F}
library(tidyverse)
library(raster)
library(rasterVis)
library(rgdal)
library(sf)
library(spData)
library(ncdf4)
library(readxl)
library(stats)
library(lubridate)
library(leaflet)
library(httr)
library(jsonlite)
```

## Download and clean all required data
```{r, eval=F}
## Get and download the velocity Data frrom NSIDC

# The data has been downloaded to the data directory, to use the api, use your EarthData_taken that can be acquired at https://nsidc.org/support/how/how-request-earthdata-login-token
EarthData_taken = Sys.getenv("EARTHDATA_TOKEN")
url = paste0("https://n5eil02u.ecs.nsidc.org/egi/request?short_name=NSIDC-0481&token=",
             EarthData_taken,
             "&email=yes&version=2&time=2016-01-01T00:00:00,2016-12-31T00:00:00&bounding_box=-52.5,68.8,-47.5,69.5&agent=NO&INCLUDE_META=N&page_size=200&page_num=1")
data = GET(url)

# Download and save data locally
dir.create("data")
file_vel = file(file.path("data", "nsidc0481_16.zip"), "wb") 
writeBin(data$content, file_vel)
close(file_vel)

# Unzip file
data_dir = "data/nsidc0481_16"
dir.create(data_dir)
unzip("data/nsidc0481_16.zip", exdir = data_dir)
```

```{r, eval=F}
## Clean velocity data and crop raster

data_dir = "data/nsidc0481_16"
names = dir(data_dir, pattern = "^.*vv.*$", full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
names = gsub("^.*68.6.*$", "", names)
names = names[names != ""]
stack_velRaster = stack(names)

# Get dates
date = substr(names, 41, 47)
date = as.Date(format(as.POSIXct(date, format = '%d%b%Y'), "20%y-%m-%d"))
write.csv(date,file="data/vel_Raster_date.csv",row.names=F)

# Crop rasterstack
new_extent = as(extent(-185000, -160000, -2290000, -2272000), 'SpatialPolygons')
crs(new_extent) = crs(stack_velRaster)
stack_velRaster = crop(stack_velRaster, new_extent)

# Save the cropped rasterstack
writeRaster(stack_velRaster, filename="data/stack_velRaster.tif", options="INTERLEAVE=BAND", overwrite=TRUE)
```

```{r, message=F, warning=F}
## Read raster data into Rstudio
stack_velRaster = stack("data/stack_velRaster.tif")
date = as.Date(read.csv("data/vel_Raster_date.csv")$x)
stack_velRaster = setZ(stack_velRaster, date)
```

```{r, message=F, warning=F}
## Extract time series of velocity at six example locations

pts_coord = read_excel("data/Selected_pts.xlsx")
pts = SpatialPoints(data.frame(x=pts_coord$X,y=pts_coord$Y))
projection(pts) = crs(stack_velRaster)

vel = raster::extract(stack_velRaster, pts, buffer=100, fun=mean, na.rm=T)
veldf = as.data.frame(t(vel))
veldf$Date = date
rownames(veldf) <- NULL
veldf = veldf %>%
  arrange(date)
```

```{r}
## Read runoff data and resample to the index of velocity time series

runoff = read_excel("data/runoff_sum_abl.xlsx")
runoff_16 = runoff[year(runoff$Date) == 2016,] %>%
  mutate(Date = as.Date(Date))

# resampling
runoff_interp = as.data.frame(approx(runoff_16$Date,runoff_16$runoff_sum_abl, xout = veldf$Date, 
       rule = 1, method = "linear", ties = mean)) %>%
  rename(Date = "x", runoff = "y")

# merge with velocity dataframe and only keep the melting season
vel_runoff = left_join(veldf, runoff_interp, by="Date")
vel_runoff = vel_runoff[vel_runoff$runoff > 200,]
```

```{r, eval=F}
## Preprocess Air temperature data: resample to lower resolution and save

tskin = stack("data/t2m.2016.BN_RACMO2.3p2_ERA5_3h_FGRN055.1km.MM.nc", varname = "t2mcorr")
crs(tskin) = '+proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs '
row1 = cbind(-Inf, 150, NA)
row2 = cbind(320, +Inf, NA)
tskin = reclassify(tskin, rbind(row1, row2), right=FALSE)
names(tskin) = month.name

# resample to lower resolution
tskin_aggregate <- aggregate(tskin, fact=30)
writeRaster(tskin_aggregate, filename="data/t2m.2016.BN_RACMO2.3p2.tif", options="INTERLEAVE=BAND", overwrite=TRUE)
```

```{r, message=F}
## Read Air temperature data into Rstudio
tskin = stack("data/t2m.2016.BN_RACMO2.3p2.tif")
names(tskin) = month.name
```

```{r, message=F}
## Convert to time series of air temperature at every location
ts_tskin = matrix(data=NA, nrow=ncell(tskin), ncol=12)
for(i in 1:12){
  ts_tskin[,i] = c(as.matrix(tskin[[i]]))
}

ts_tskin = as.data.frame(t(ts_tskin))
ts_tskin$Date = runoff_16$Date

ts_tskin_res = matrix(data=NA, nrow=nrow(veldf), ncol=ncell(tskin))
ts_corr = vector()
for(j in 1:ncell(tskin)){
  if (!all(is.na(ts_tskin[,j]))){
     y = approx(ts_tskin$Date,ts_tskin[,j], xout = veldf$Date, 
                rule = 1, method = "linear", ties = mean)$y
    ts_tskin_res[,j] = y
    ts_corr[j] = cor(y, veldf$V1, use = "complete.obs")
  }
  else{
    ts_corr[j] = NA
  }
}

ma_corr = matrix(ts_corr, nrow = nrow(tskin), ncol = ncol(tskin))
corr_raster = raster(nrows=nrow(tskin), ncols=ncol(tskin))
crs(corr_raster) <- crs(tskin)
extent(corr_raster) <- extent(tskin)
values(corr_raster) = ma_corr
```

# Results

[~200 words]

Tables and figures (maps and other graphics) are carefully planned to convey the results of your analysis. Intense exploration and evidence of many trials and failures. The author looked at the data in many different ways before coming to the final presentation of the data.

Show tables, plots, etc. and describe them.

```{r, message=F, warning=F, fig.width=6, fig.height=3, fig.cap="Exmaple map of surface ice velocity"}
exam_vel = stack_velRaster[[1]]
leaflet() %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles("Esri.WorldImagery", group = "Esri World Imagery") %>%
  addRasterImage(exam_vel, group = "Example velocity map") %>%
  addCircleMarkers(data = spTransform(pts, "+proj=longlat +datum=WGS84 +no_defs"), group = "Selected points") %>%
  setView(lng = -49.5, lat = 69.1, zoom = 8.5) %>%
  addLayersControl(baseGroups = c("OSM", "Esri World Imagery"), 
                   overlayGroups = c("Example velocity map", "Selected points"))
```

```{r, message=F, warning=F, fig.width=6, fig.height=3, fig.cap="Surface ice velocity time series in 2016"}
ggplot(veldf) +
  geom_point(aes(Date, V1)) +
  theme_bw() +
  labs(y = "Surface ice velocity at point 1 (m/year)")
```

```{r, message=F, warning=F, fig.width=6, fig.height=3, fig.cap="Comparison of surface ice velocity and runoff"}
ggplot(vel_runoff, aes(x = log(runoff), y = V1)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme_bw() +
  labs(x = "Runoff (mmwe/month, logscale)", y = "Surface ice velocity (m/year)")
```


```{r, message=F, warning=F, fig.width=6, fig.height=6, fig.cap="Correlation map of surface ice velocity at point 1 with air temperature"}
plot(corr_raster)
```

# Conclusions

[~200 words]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References

All sources are cited in a consistent manner
